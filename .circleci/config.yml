version: 2
cache_keys:
  gradle_cache:
    primary: &primary_key_of_gradle_cache gradle-cache-{{ checksum "build.gradle" }}}-{{ checksum "app/build.gradle" }}
    keys: &all_keys_of_gradle_cache
    - *primary_key_of_gradle_cache

shared_build_steps:
- run: &init_bash
    name: Source the bash source
    command: |
      echo "export REPOSITORY_ROOT=$(git rev-parse --show-toplevel)" >> $BASH_ENV
      source $BASH_ENV

defaults: &defaults
  working_directory: ~/sample_code_programs
  docker:
  - image: circleci/android:api-27-alpha
  environment:
    JVM_OPTS: -Xmx3200m
    TZ: Asia/Tokyo

jobs:
  fetch:
    <<: *defaults
    steps:
    - checkout
    - run: *init_bash
    - restore_cache: &restore_gradle_cache
        keys: *all_keys_of_gradle_cache
    - run:
        name: update android sdk
        command: |
          echo y | android update sdk --no-ui --all --filter tool,extra-android-m2repository,extra-google-google_play_services,extra-google-m2repository,android-27
          echo y | android update sdk --no-ui --all --filter build-tools-27.0.0
    - run:
        name: Download Dependencies
        command: ./gradlew androidDependencies
    - save_cache:
        paths:
        - ~/.android
        - ~/.gradle
        - .gradle
        - ~/.ssh
        key: *primary_key_of_gradle_cache
    - persist_to_workspace:
        root: .
        paths:
        - .

  test:
    <<: *defaults
    steps:
    - attach_workspace: &attach_workspace_sample_code_programs
        at: .
    - run: *init_bash
    - restore_cache: *restore_gradle_cache
    - run:
        name: Run Tests
        command: |
          ./gradlew test
          ./gradlew lint test
    - run: &store_test_result_files
        name: Store Test Results
        command: |
          mkdir -p ~/cayenne_android/junit/
          find . -type f -regex ".*/test-results/*/.*xml" -exec cp {} ~/sample_code_programs/junit/ \;
        when: always
    - store_test_results:
        path: ~/sample_code_programs/junit
    - store_artifacts:
        path: ~/sample_code_programs/app/build/reports/tests

  build_debug:
    <<: *defaults
    steps:
      - attach_workspace: *attach_workspace_sample_code_programs
      - run: *init_bash
      - restore_cache: *restore_gradle_cache
      - run:
          name: assembleDebug
          command: ./gradlew assembleDebug

  attach_tag_debug:
    <<: *defaults
    steps:
      - attach_workspace: *attach_workspace_sample_code_programs
      - run: *init_bash
      - restore_cache: *restore_gradle_cache
      - add_ssh_keys:
          fingerprints:
            - "2b:07:73:d6:b9:f0:ef:b9:25:53:81:73:83:6d:21:c6"
      - run:
          name: Attach debug tag
          command: |
            git tag v_0.1
            git push origin --tags

workflows:
  version: 2
  run_ci:
    jobs:
      - fetch
      - test:
          requires:
          - fetch
      - build_debug:
          requires:
          - fetch
      - attach_tag_debug:
          requires:
          - build_debug


